services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ocg
      POSTGRES_PASSWORD: ocg
      POSTGRES_DB: ocg
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      OCG_DATABASE_URL: postgresql+psycopg://ocg:ocg@postgres:5432/ocg
      OCG_REDIS_URL: redis://redis:6379/0
      OCG_AUTH_MODE: oidc
      OCG_OIDC_ISSUER: https://dev-issuer.local
      OCG_OIDC_AUDIENCE: ocg-api
      OCG_OIDC_HS256_SECRET: dev-secret
      OCG_DEV_AUTH_ENABLED: "true"
      OCG_SERVER_BIND: 0.0.0.0
      OCG_RETENTION_ENABLED: "true"
      OCG_K_ANONYMITY_K: 1
      OCG_K_ANONYMITY_N: 1
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis

  workers:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: ["python", "-m", "ocg.cli", "worker", "run"]
    environment:
      OCG_DATABASE_URL: postgresql+psycopg://ocg:ocg@postgres:5432/ocg
      OCG_REDIS_URL: redis://redis:6379/0
      OCG_AUTH_MODE: oidc
      OCG_OIDC_ISSUER: https://dev-issuer.local
      OCG_OIDC_AUDIENCE: ocg-api
      OCG_OIDC_HS256_SECRET: dev-secret
      OCG_DEV_AUTH_ENABLED: "true"
      OCG_SERVER_BIND: 0.0.0.0
    depends_on:
      - postgres
      - redis

  scheduler:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: ["python", "-m", "ocg.cli", "worker", "scheduler"]
    environment:
      OCG_DATABASE_URL: postgresql+psycopg://ocg:ocg@postgres:5432/ocg
      OCG_REDIS_URL: redis://redis:6379/0
      OCG_AUTH_MODE: oidc
      OCG_OIDC_ISSUER: https://dev-issuer.local
      OCG_OIDC_AUDIENCE: ocg-api
      OCG_OIDC_HS256_SECRET: dev-secret
      OCG_DEV_AUTH_ENABLED: "true"
      OCG_SERVER_BIND: 0.0.0.0
      OCG_WORKER_SCHEDULER_INTERVAL_SECONDS: 120
    depends_on:
      - postgres
      - redis

  ui:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: http://api:8080
    ports:
      - "3000:3000"
    depends_on:
      - api

volumes:
  pgdata:
